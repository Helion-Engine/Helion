<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <UseWindowsForms>false</UseWindowsForms>
    <RootNamespace>Helion.Client</RootNamespace>

    <TieredCompilation>false</TieredCompilation>
    <AssemblyName>Helion</AssemblyName>
    <ApplicationIcon>helion.ico</ApplicationIcon>

    <AllowUnsafeBlocks>True</AllowUnsafeBlocks>
    <NoWarn>1701;1702;NU1701</NoWarn>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <TreatWarningsAsErrors>false</TreatWarningsAsErrors>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)'=='Release'">
    <WarningLevel>0</WarningLevel>
  </PropertyGroup>

  <ItemGroup>
    <Content Include="helion.ico" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="NAudio.Vorbis" Version="1.5.0" />
    <PackageReference Include="nfluidsynth" Version="0.3.1" />
    <PackageReference Include="OpenAL.Soft" Version="1.19.1" />
    <PackageReference Include="OpenTK" Version="4.7.4" />
  </ItemGroup>
  
  <PropertyGroup Condition="'$(RuntimeIdentifier)' == 'win-x64' OR '$(RuntimeIdentifier)' == 'win-x86'">
    <!-- Publishing settings; tested extensively on Windows but not Linux, so currently restricted to just Windows -->
    <SelfContained>True</SelfContained>
    <PublishSingleFile>True</PublishSingleFile>
    <PublishReadyToRun>True</PublishReadyToRun>
    <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile >
  </PropertyGroup>


  <ItemGroup>
    <ProjectReference Include="..\Core\Core.csproj" />
  </ItemGroup>

  <Target Name="GetSupportFiles">
    <ItemGroup>
      <SoundFonts Include="$(ProjectDir)SoundFonts\**\*.sf2" />

      <!-- Runtime specified, e.g. "-r win-x64"; copy native files into root -->
      <NativeFiles Include="$(ProjectDir)Unmanaged\win-x64\**\*" Destination="%(RecursiveDir)" Condition="'$(RuntimeIdentifier)' == 'win-x64'" />
      <NativeFiles Include="$(ProjectDir)Unmanaged\win-x86\**\*" Destination="%(RecursiveDir)" Condition="'$(RuntimeIdentifier)' == 'win-x86'" />

      <!-- Runtime unspecified; copy native files into runtimes\(runtimeID)\native  -->
      <NativeFiles Include="$(ProjectDir)Unmanaged\win-x64\**\*" Destination="runtimes\win-x64\native\%(RecursiveDir)" Condition="'$(RuntimeIdentifier)' == ''" />
      <NativeFiles Include="$(ProjectDir)Unmanaged\win-x64\**\*" Destination="runtimes\win-x86\native\%(RecursiveDir)" Condition="'$(RuntimeIdentifier)' == ''" />

      <!-- Files used to determine whether the "copy support files" targets need to run  -->
      <TargetAssetsFile Include="$(TargetDir)assets.pk3" />
      <PublishAssetsFile Include="$(PublishDir)assets.pk3" />
      <AllSupportFiles Include="@(NativeFiles)" />
      <AllSupportFiles Include="@(SoundFonts)" />
      <AllSupportFiles Include="$(HelionRootDir)Assets\Assets\**\*" />
    </ItemGroup>
  </Target>

  <Target Name="CopySupportFilesForBuild" AfterTargets="Build" DependsOnTargets="GetSupportFiles" Inputs="@(AllSupportFiles)" Outputs="@(TargetAssetsFile)">
    <!-- Copy SoundFont for FluidSynth, create assets.pk3 -->
    <Copy SourceFiles="@(SoundFonts)" DestinationFolder="$(TargetDir)SoundFonts\%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(NativeFiles)" DestinationFolder="$(TargetDir)%(Destination)" SkipUnchangedFiles="true" />
    <ZipDirectory SourceDirectory="$(HelionRootDir)Assets\Assets" DestinationFile="@(TargetAssetsFile)" Overwrite="true" />
  </Target>

  <Target Name="CopySupportFilesForPublish" AfterTargets="Publish" DependsOnTargets="GetSupportFiles" Inputs="@(AllSupportFiles)" Outputs="@(PublishAssetsFile)">
    <!-- The previous steps that copy support files to the target directory do NOT copy on publish, so we have to handle that again. -->
    <Copy SourceFiles="@(SoundFonts)" DestinationFolder="$(PublishDir)SoundFonts\%(RecursiveDir)" SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(NativeFiles)" DestinationFolder="$(PublishDir)%(Destination)" SkipUnchangedFiles="true" />
    <Copy SourceFiles="@(TargetAssetsFile)" DestinationFolder="$(PublishDir)" SkipUnchangedFiles="true" />
  </Target>

</Project>
